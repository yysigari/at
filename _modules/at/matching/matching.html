
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>at.matching.matching &#8212; Accelerator Toolbox 0.1.dev1+gba07c8d documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom_at.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
    <img src="../../../_static/AT.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../_static/AT.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../p/index.html">
  Python
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../m/index.html">
  Matlab
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../pabout.html">
  About
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <span id="theme-switch" class="btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/atcollab/at" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <h1>Source code for at.matching.matching</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes for matching variables and constraints</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">least_squares</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">at.lattice</span> <span class="kn">import</span> <span class="n">Lattice</span><span class="p">,</span> <span class="n">Refpts</span><span class="p">,</span> <span class="n">bool_refpts</span>
<span class="kn">from</span> <span class="nn">at.physics</span> <span class="kn">import</span> <span class="n">get_optics</span><span class="p">,</span> <span class="n">ohmi_envelope</span><span class="p">,</span> <span class="n">find_orbit</span>


<div class="viewcode-block" id="Variable"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Variable">[docs]</a><span class="k">class</span> <span class="nc">Variable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A :py:class:`Variable` is a scalar value acting on a lattice through the</span>
<span class="sd">    user-defined functions setfun and getfun</span>

<span class="sd">    Parameters:</span>
<span class="sd">        setfun:     User-defined function for setting the Variable. Called as:</span>

<span class="sd">          :code:`setfun(ring, value, *args, **kwargs)`</span>

<span class="sd">          where :code:`value` is the scalar value to apply</span>

<span class="sd">          The positional and keyword parameters come from the</span>
<span class="sd">          :py:class:`Variable` initialisation</span>
<span class="sd">        getfun:     User-defined function for retrieving the actual value of</span>
<span class="sd">          the variable: Called as:</span>

<span class="sd">          :code:`value = getfun(ring, *args, **kwargs)`</span>

<span class="sd">          The positional and keyword parameters come from the</span>
<span class="sd">          :py:class:`Variable` initialisation</span>
<span class="sd">        name:       Name of the Variable; Default: ``&#39;&#39;``</span>
<span class="sd">        bounds:     Lower and upper bounds of the variable value</span>
<span class="sd">        *args:      Positional arguments transmitted to ``setfun`` and</span>
<span class="sd">          ``getfun`` functions</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        **kwargs:   Keyword arguments transmitted to ``setfun``and</span>
<span class="sd">          ``getfun`` functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setfun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">getfun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">bounds</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setfun</span> <span class="o">=</span> <span class="n">setfun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getfun</span> <span class="o">=</span> <span class="n">getfun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Variable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="Variable.set"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Variable.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the variable value&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setfun</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variable.get"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Variable.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the actual variable value&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfun</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variable.header"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Variable.header">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">():</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:&gt;12s}{:&gt;13s}{:&gt;16s}{:&gt;16s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Initial&#39;</span><span class="p">,</span> <span class="s1">&#39;Final &#39;</span><span class="p">,</span> <span class="s1">&#39;Variation&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variable.status"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Variable.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="n">vini</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">):</span>
        <span class="n">vnow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:&gt;12s}{: 16e}{: 16e}{: 16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vini</span><span class="p">,</span> <span class="n">vnow</span><span class="p">,</span> <span class="p">(</span><span class="n">vnow</span> <span class="o">-</span> <span class="n">vini</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="ElementVariable"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.ElementVariable">[docs]</a><span class="k">class</span> <span class="nc">ElementVariable</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An :py:class:`ElementVariable` is:</span>

<span class="sd">    * a scalar attribute or</span>
<span class="sd">    * an element of an array attribute</span>

<span class="sd">    of one or several :py:class:`.Element` (s) of a lattice.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        refpts:     Location of variable :py:class:`.Element` (s)</span>
<span class="sd">        attname:    Attribute name</span>
<span class="sd">        index:      Index in the attribute array. Use :py:obj:`None` for</span>
<span class="sd">          scalar attributes</span>
<span class="sd">        name:       Name of the Variable; Default: ``&#39;&#39;``</span>
<span class="sd">        bounds:     Lower and upper bounds of the variable value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span> <span class="n">attname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">bounds</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)):</span>
        <span class="n">setf</span><span class="p">,</span> <span class="n">getf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">setfun</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ring</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">refpts</span><span class="p">):</span>
                <span class="n">setf</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">getfun</span><span class="p">(</span><span class="n">ring</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">getf</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attname</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span>
                               <span class="n">ring</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">refpts</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ElementVariable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">setfun</span><span class="p">,</span> <span class="n">getfun</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refpts</span> <span class="o">=</span> <span class="n">refpts</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_access</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access to element attributes&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">setf</span> <span class="o">=</span> <span class="nb">setattr</span>
            <span class="n">getf</span> <span class="o">=</span> <span class="nb">getattr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">setf</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">def</span> <span class="nf">getf</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">setf</span><span class="p">,</span> <span class="n">getf</span></div>


<div class="viewcode-block" id="Constraints"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Constraints">[docs]</a><span class="k">class</span> <span class="nc">Constraints</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for generic constraints:</span>

<span class="sd">    * a constraint is defined by a user-defined evaluation function,</span>
<span class="sd">    * constraints are added to the container with the :py:meth:`add` method.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        *args:      Positional arguments sent to the evaluation functions</span>
<span class="sd">          of all the embedded constraints</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        **kwargs:   Keyword arguments sent to the evaluation functions</span>
<span class="sd">          of all the embedded constraints</span>

<span class="sd">    Examples:</span>
<span class="sd">        Define an evaluation function for the ring circumference:</span>

<span class="sd">        &gt;&gt;&gt; def circ_fun(ring):</span>
<span class="sd">        ...     return ring.get_s_pos(len(ring) + 1)</span>

<span class="sd">        Define an evaluation function for the momentum compaction factor:</span>

<span class="sd">        &gt;&gt;&gt; def mcf_fun(ring):</span>
<span class="sd">        ...     return ring.get_mcf()</span>

<span class="sd">        Construct the container:</span>

<span class="sd">        &gt;&gt;&gt; cnstrs = Constraints()</span>

<span class="sd">        Add the two constraints:</span>

<span class="sd">        &gt;&gt;&gt; cnstrs.add(circ_fun, 850.0)</span>
<span class="sd">        &gt;&gt;&gt; cnstrs.add(mcf_fun, 1.0e-4, weight=0.1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbound</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubound</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="Constraints.add"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Constraints.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Add a target to the :py:class:`Constraints` container</span>

<span class="sd">        .. highlight:: python</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fun:          Evaluation function. Called as:</span>

<span class="sd">              :code:`value = fun(ring, *args, **kwargs)`</span>

<span class="sd">              ``value`` is the constrained parameter value,</span>

<span class="sd">              ``value`` may be a scalar or an array.</span>

<span class="sd">              The positional and keyword parameters come from</span>
<span class="sd">              the :py:class:`Constraints` initialisation</span>
<span class="sd">            target:       Desired value.</span>
<span class="sd">            name:         Name of the constraint. If :py:obj:`None`, a ``name``</span>
<span class="sd">              is generated from the name of the evaluation function</span>
<span class="sd">            weight:       Weight factor: the residual is</span>
<span class="sd">              :code:`(value-target)/weight`</span>
<span class="sd">            bounds:       Lower and upper bounds. The parameter is constrained</span>
<span class="sd">              in the interval [target-low_bound target+up_bound]</span>

<span class="sd">        The &quot;target&quot;, &quot;weight&quot; and &quot;bounds&quot; input must be broadcastable to the</span>
<span class="sd">        shape of &quot;value&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                <span class="c1"># Generate the constraint name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">lbound</span><span class="p">,</span> <span class="n">ubound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">bounds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ubound</span><span class="p">)</span></div>

<div class="viewcode-block" id="Constraints.values"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Constraints.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of actual parameter values&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fun</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">]</span></div>

<div class="viewcode-block" id="Constraints.evaluate"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Constraints.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a flattened array of weighted residuals&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">res</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">lbound</span><span class="p">,</span> <span class="n">ubound</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">target</span>   <span class="c1"># broadcast here =&gt; at least 1 dimension</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">+</span> <span class="n">lbound</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">-</span> <span class="n">ubound</span>
            <span class="n">lb</span><span class="p">[</span><span class="n">lb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># needs at least 1 dimension</span>
            <span class="n">ub</span><span class="p">[</span><span class="n">ub</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lb</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ub</span><span class="p">))</span> <span class="o">/</span> <span class="n">weight</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">res</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ib</span>
                               <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbound</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">ubound</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Constraints.header"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Constraints.header">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Header for the display of constraint values and residuals&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:&gt;12s}{:&gt;13s}{:&gt;16s}{:&gt;16s}{:&gt;16s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Initial&#39;</span><span class="p">,</span> <span class="s1">&#39;Final &#39;</span><span class="p">,</span> <span class="s1">&#39;Target&#39;</span><span class="p">,</span> <span class="s1">&#39;Residual&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Constraints.status"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.Constraints.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string giving the actual state of constraints&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initial</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="n">strs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">):</span>
            <span class="n">now</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">vt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span>
                                  <span class="n">now</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
                <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&gt;12s}{: 16e}{: 16e}{: 16e}{: 16e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="n">vn</span> <span class="o">-</span> <span class="n">vt</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ElementConstraints"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.ElementConstraints">[docs]</a><span class="k">class</span> <span class="nc">ElementConstraints</span><span class="p">(</span><span class="n">Constraints</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for position-related constraints: handle the refpoints</span>
<span class="sd">    of each target&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nelems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refpts</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">bool_refpts</span><span class="p">([])</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ElementConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_arrayaccess</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access to array elements&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">getv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">getv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">getv</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_recordaccess</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access to optics parameters&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">getf</span> <span class="o">=</span> <span class="nb">getattr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">Ellipsis</span><span class="p">,)</span><span class="o">+</span><span class="n">index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">Ellipsis</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">getf</span><span class="p">(</span><span class="n">lindata</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lindata</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">getf</span>

<div class="viewcode-block" id="ElementConstraints.add"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.ElementConstraints.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
            <span class="n">refpts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Refpts</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a target to the :py:class:`ElementConstraints` container</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fun:          Evaluation function. Called as:</span>

<span class="sd">              :code:`value = fun(ring, *args, **kwargs)`</span>

<span class="sd">              ``value`` is the constrained parameter value</span>

<span class="sd">              ``value`` may be a scalar or an array.</span>

<span class="sd">              the positional and keyword parameters come from</span>
<span class="sd">              the :py:class:`ElementConstraints` initialisation</span>
<span class="sd">            target:       Desired value.</span>
<span class="sd">            refpts:       Location of the constraint</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            name:         Name of the constraint. If :py:obj:`None`, a ``name``</span>
<span class="sd">              is generated from the name of the evaluation function</span>
<span class="sd">            weight:       Weight factor: the residual is</span>
<span class="sd">              :code:`(value-target)/weight`</span>
<span class="sd">            bounds:       Lower and upper bounds. The parameter is constrained</span>
<span class="sd">              in the interval [target-low_bound target+up_bound]</span>

<span class="sd">        The &quot;target&quot;, &quot;weight&quot; and &quot;bounds&quot; input must be broadcastable to the</span>
<span class="sd">        shape of &quot;value&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">bool_refpts</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelems</span><span class="p">)</span>
        <span class="c1"># Store the new refpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="c1"># Update the union of all refpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ElementConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElementConstraints.values"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.ElementConstraints.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">):</span>
        <span class="c1"># Single optics computation</span>
        <span class="n">vloc</span><span class="p">,</span> <span class="n">vglob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Evaluate all constraints</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fun</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">vglob</span><span class="p">)</span> <span class="k">for</span> <span class="n">fun</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="n">vloc</span><span class="p">)]</span></div>

<div class="viewcode-block" id="ElementConstraints.compute"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.ElementConstraints.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dummy computation. Compute must return:</span>
<span class="sd">        - an iterator over local data for each target</span>
<span class="sd">        - a tuple of global data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="p">()</span></div></div>


<div class="viewcode-block" id="LinoptConstraints"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.LinoptConstraints">[docs]</a><span class="k">class</span> <span class="nc">LinoptConstraints</span><span class="p">(</span><span class="n">ElementConstraints</span><span class="p">):</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
    <span class="sd">&quot;&quot;&quot;Container for linear optics constraints:</span>

<span class="sd">    * a constraint can be set on any result of at.get_optics</span>
<span class="sd">    * constraints are added to the container with the LinoptConstraints.add</span>
<span class="sd">      method.</span>

<span class="sd">    :py:func:`.get_optics` is called once before the evaluation of all</span>
<span class="sd">    constraints</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:       Lattice description</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        dp (float):   Momentum deviation.</span>
<span class="sd">        dct (float):  Path lengthening. If specified, ``dp`` is</span>
<span class="sd">          ignored and the off-momentum is deduced from the path lengthening.</span>
<span class="sd">        orbit (Optional[Orbit]): Avoids looking for the closed orbit if is</span>
<span class="sd">          already known ((6,) array)</span>
<span class="sd">        twiss_in:   Initial twiss parameters for transfer line optics.</span>
<span class="sd">          See :py:func:`.linopt6`</span>
<span class="sd">        method (Callable):  Method used for the analysis of the</span>
<span class="sd">          transfer matrix. Can be :py:obj:`~.linear.linopt2`,</span>
<span class="sd">          :py:obj:`~.linear.linopt4`, :py:obj:`~.linear.linopt6`</span>

<span class="sd">          * :py:obj:`~.linear.linopt2`: No longitudinal motion, no H/V coupling,</span>
<span class="sd">          * :py:obj:`~.linear.linopt4`: No longitudinal motion, Sagan/Rubin</span>
<span class="sd">            4D-analysis of coupled motion,</span>
<span class="sd">          * :py:obj:`~.linear.linopt6` (default): With or without longitudinal</span>
<span class="sd">            motion, normal mode analysis</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; cnstrs = LinoptConstraints(ring, dp=0.01, coupled=False)</span>

<span class="sd">        Add a beta x (beta[0]) constraint at location ref_inj:</span>

<span class="sd">        &gt;&gt;&gt; cnstrs.add(&#39;beta&#39;, 18.0, refpts=ref_inj, name=&#39;beta_x_inj&#39;, index=0)</span>

<span class="sd">        Add an horizontal tune (tunes[0]) constraint:</span>

<span class="sd">        &gt;&gt;&gt; cnstrs.add(&#39;tunes&#39;, 0.44, index=0, weight=0.01)</span>

<span class="sd">        Add a chromaticity constraint (both planes):</span>

<span class="sd">        &gt;&gt;&gt; cnstrs.add(&#39;chroms&#39;, [0.0 0.0])</span>

<span class="sd">        Define a constraint of phase advances between 2 points:</span>

<span class="sd">        &gt;&gt;&gt; def mu_diff(lindata, tune, chrom):</span>
<span class="sd">        ...     delta_mu = (lindata[1].mu - lindata[0].mu)/(2*np.pi)</span>
<span class="sd">        ...     return delta_mu % 1.0</span>

<span class="sd">        Add a H phase advance constraint, giving the desired locations:</span>

<span class="sd">        &gt;&gt;&gt; cnstrs.add(mu_diff, 0.5, refpts=[sf0 sf1], index=0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_chrom</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinoptConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="LinoptConstraints.add"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.LinoptConstraints.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Refpts</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a target to the LinoptConstraints container</span>

<span class="sd">        Parameters:</span>
<span class="sd">            param:         2 possibilities:</span>

<span class="sd">              * parameter name: see :py:func:`.linopt6` for the</span>
<span class="sd">                name of available parameters. In addition to local</span>
<span class="sd">                optical parameters, ``&#39;tunes&#39;`` and ``&#39;chroms&#39;``</span>
<span class="sd">                are allowed.</span>
<span class="sd">              * user-supplied parameter evaluation function:</span>

<span class="sd">                :code:`value = param(lindata, tune, chrom)`</span>

<span class="sd">                ``lindata`` contains the optics parameters at all the</span>
<span class="sd">                specified refpoints</span>
<span class="sd">                ``value`` is the constrained parameter value</span>
<span class="sd">                (scalar or array).</span>
<span class="sd">            target:       desired value.</span>
<span class="sd">            refpts:       location of the constraint. Several locations may be</span>
<span class="sd">              given to apply the same constraint at several points.</span>
<span class="sd">            index:        index in the parameter array. If :py:obj:`None`,</span>
<span class="sd">              the full array is used.</span>
<span class="sd">            name:         name of the constraint. If :py:obj:`None`, name is</span>
<span class="sd">              generated from ``param`` and ``index``.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            weight:       Weight factor: the residual is</span>
<span class="sd">              :code:`(value-target)/weight`</span>
<span class="sd">            bounds:       lower and upper bounds. The parameter is constrained</span>
<span class="sd">                          in the interval [target-low_bound target+up_bound]</span>
<span class="sd">            UseInteger:   Match integer part of mu, much slower as the optics</span>
<span class="sd">                          calculation is done for all refpts</span>

<span class="sd">        The target, weight and bounds values must be broadcastable to the shape</span>
<span class="sd">        of value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recordaccess</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">getv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayaccess</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">use_integer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;UseInteger&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                <span class="c1"># Generate the constraint name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">else</span> <span class="n">param</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">tune</span><span class="p">,</span> <span class="n">chrom</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">getv</span><span class="p">(</span><span class="n">param</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">tune</span><span class="p">,</span> <span class="n">chrom</span><span class="p">))</span>
            <span class="c1"># self.refpts[:] = True     # necessary not to miss 2*pi jumps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_chrom</span> <span class="o">=</span> <span class="kc">True</span>       <span class="c1"># fun may use dispersion or chroma</span>
        <span class="k">elif</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;tunes&#39;</span><span class="p">:</span>
            <span class="c1"># noinspection PyUnusedLocal</span>
            <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">tune</span><span class="p">,</span> <span class="n">chrom</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">getv</span><span class="p">(</span><span class="n">tune</span><span class="p">)</span>
            <span class="n">refpts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;chroms&#39;</span><span class="p">:</span>
            <span class="c1"># noinspection PyUnusedLocal</span>
            <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">tune</span><span class="p">,</span> <span class="n">chrom</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">getv</span><span class="p">(</span><span class="n">chrom</span><span class="p">)</span>
            <span class="n">refpts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_chrom</span> <span class="o">=</span> <span class="kc">True</span>       <span class="c1"># slower but necessary</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># noinspection PyUnusedLocal</span>
            <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">tune</span><span class="p">,</span> <span class="n">chrom</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">getf</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;mu&#39;</span> <span class="ow">and</span> <span class="n">use_integer</span><span class="p">:</span>
                    <span class="c1"># necessary not to miss 2*pi jumps</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">getf</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LinoptConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinoptConstraints.compute"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.LinoptConstraints.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optics computation before evaluation of all constraints&quot;&quot;&quot;</span>
        <span class="n">ld0</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">ld</span> <span class="o">=</span> <span class="n">get_optics</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">,</span>
                                 <span class="n">get_chrom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_chrom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">]]</span> <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">),</span> \
               <span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">tune</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">bd</span><span class="o">.</span><span class="n">chromaticity</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OrbitConstraints"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.OrbitConstraints">[docs]</a><span class="k">class</span> <span class="nc">OrbitConstraints</span><span class="p">(</span><span class="n">ElementConstraints</span><span class="p">):</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
    <span class="sd">&quot;&quot;&quot;Container for orbit constraints:</span>
<span class="sd">    The closed orbit can be handled with :py:class`LinoptConstraints`, but for</span>
<span class="sd">    problems which do not involve parameters other than orbit, like steering or</span>
<span class="sd">    orbit bumps, :py:class:`OrbitConstraints` is much faster.</span>

<span class="sd">    :py:func:`.find_orbit` is called once before the evaluation of all</span>
<span class="sd">    constraints</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:       Lattice description</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        dp (float):   Momentum deviation.</span>
<span class="sd">        dct (float):  Path lengthening. If specified, ``dp`` is</span>
<span class="sd">          ignored and the off-momentum is deduced from the path lengthening.</span>
<span class="sd">        orbit (Optional[Orbit]): Avoids looking for the closed orbit if is</span>
<span class="sd">          already known ((6,) array)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; cnstrs = OrbitConstraints(ring, dp=0.01)</span>

<span class="sd">        Add a bump (x=-0.004, x&#39;=0) constraint at location ref_inj</span>

<span class="sd">        &gt;&gt;&gt; cnstrs.add([-0.004, 0.0], refpts=ref_inj, index=slice(2))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ring</span><span class="o">.</span><span class="n">radiation</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dct&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OrbitConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="OrbitConstraints.add"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.OrbitConstraints.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Refpts</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a target to the OrbitConstraints container</span>

<span class="sd">        Parameters:</span>
<span class="sd">            target:       desired value.</span>
<span class="sd">            refpts:       location of the constraint. Several locations may be</span>
<span class="sd">              given to apply the same constraint at several points.</span>
<span class="sd">            index:        index in the orbit vector. If :py:obj:`None`, the</span>
<span class="sd">              full orbit is used.</span>
<span class="sd">            name:         name of the constraint. Default: ``&#39;orbit&#39;``</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            weight:       Weight factor: the residual is</span>
<span class="sd">              :code:`(value-target)/weight`</span>
<span class="sd">            bounds:       lower and upper bounds. The parameter is constrained</span>
<span class="sd">                          in the interval [target-low_bound target+up_bound]</span>

<span class="sd">        The target, weight and bounds values must be broadcastable to the shape</span>
<span class="sd">        of value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                <span class="c1"># Generate the constraint name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;orbit&#39;</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;orbit_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayaccess</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OrbitConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OrbitConstraints.compute"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.OrbitConstraints.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Orbit computation before evaluation of all constraints&quot;&quot;&quot;</span>
        <span class="n">orbit0</span><span class="p">,</span> <span class="n">orbit</span> <span class="o">=</span> <span class="n">find_orbit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">orbit</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">),</span> <span class="p">()</span></div></div>


<div class="viewcode-block" id="EnvelopeConstraints"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.EnvelopeConstraints">[docs]</a><span class="k">class</span> <span class="nc">EnvelopeConstraints</span><span class="p">(</span><span class="n">ElementConstraints</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for envelope constraints:</span>

<span class="sd">    * a constraint can be set on any result of :py:func:`.ohmi_envelope`,</span>
<span class="sd">    * constraints are added to the container with the :py:meth:`add` method.</span>

<span class="sd">    :py:func:`.ohmi_envelope` is called once before the evaluation of all</span>
<span class="sd">    constraints.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:       Lattice description</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EnvelopeConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="EnvelopeConstraints.add"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.EnvelopeConstraints.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Refpts</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a target to the :py:class:`EnvelopeConstraints` container</span>

<span class="sd">        Parameters:</span>
<span class="sd">            param:        2 possibilities:</span>

<span class="sd">              - parameter name: see :py:func:`.ohmi_envelope` for the</span>
<span class="sd">                name of available parameters. In addition to local parameters,</span>
<span class="sd">                ``&#39;tunes&#39;``, ``&#39;damping_rates&#39;``, ``&#39;mode_matrices&#39;`` and</span>
<span class="sd">                ``&#39;mode_emittance&#39;`` are allowed.</span>
<span class="sd">              - user-supplied parameter evaluation function:</span>

<span class="sd">                :code:`value = param(emit_data, beam_data)`</span>

<span class="sd">                ``emit_data`` contains the emittance data at all the</span>
<span class="sd">                specified refpoints</span>
<span class="sd">                ``value`` is the constrained parameter value</span>
<span class="sd">                (scalar or array).</span>
<span class="sd">            target:       desired value.</span>
<span class="sd">            refpts:       location of the constraint. Several locations may be</span>
<span class="sd">              given to apply the same constraint at several points.</span>
<span class="sd">            index:        index in the parameter array. If :py:obj:`None`,</span>
<span class="sd">              the full array is used.</span>
<span class="sd">            name:         name of the constraint. If :py:obj:`None`, name is</span>
<span class="sd">              generated from ``param`` and ``index``.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            weight:       Weight factor: the residual is</span>
<span class="sd">              :code:`(value-target)/weight`</span>
<span class="sd">            bounds:       lower and upper bounds. The parameter is constrained</span>
<span class="sd">                          in the interval [target-low_bound target+up_bound]</span>

<span class="sd">        The target, weight and bounds values must be broadcastable to the shape</span>
<span class="sd">        of value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">beam_constraint</span><span class="p">(</span><span class="n">prm</span><span class="p">):</span>
            <span class="c1"># noinspection PyUnusedLocal</span>
            <span class="k">def</span> <span class="nf">beamfunc</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">beam_data</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">getv</span><span class="p">(</span><span class="n">beam_data</span><span class="p">[</span><span class="n">prm</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">beamfunc</span>

        <span class="n">getf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recordaccess</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">getv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayaccess</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                <span class="c1"># Generate the constraint name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">else</span> <span class="n">param</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">beam_data</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">getv</span><span class="p">(</span><span class="n">param</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">beam_data</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tunes&#39;</span><span class="p">,</span> <span class="s1">&#39;damping_rates&#39;</span><span class="p">,</span> <span class="s1">&#39;mode_matrices&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;mode_emittances&#39;</span><span class="p">]:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">beam_constraint</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">refpts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># noinspection PyUnusedLocal</span>
            <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">beam_data</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">getf</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">EnvelopeConstraints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnvelopeConstraints.compute"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.EnvelopeConstraints.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optics computation before evaluation of all constraints&quot;&quot;&quot;</span>
        <span class="n">em0</span><span class="p">,</span> <span class="n">beamdata</span><span class="p">,</span> <span class="n">em</span> <span class="o">=</span> <span class="n">ohmi_envelope</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">em</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">refpts</span><span class="p">]]</span> <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">),</span> <span class="p">(</span><span class="n">beamdata</span><span class="p">,)</span></div></div>


<div class="viewcode-block" id="match"><a class="viewcode-back" href="../../../p/api/at.matching.matching.html#at.matching.matching.match">[docs]</a><span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Variable</span><span class="p">],</span>
          <span class="n">constraints</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Constraints</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
          <span class="n">max_nfev</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
          <span class="n">diff_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0e-10</span><span class="p">,</span>
          <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform matching of constraints by varying variables</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:               Lattice description</span>
<span class="sd">        variables:          sequence of Variable objects</span>
<span class="sd">        constraints:        sequence of Constraints objects</span>
<span class="sd">        verbose:            Print additional information</span>
<span class="sd">        max_nfev:           Maximum number of evaluations</span>
<span class="sd">        diff_step:          Convergence threshold</span>
<span class="sd">        method:</span>
<span class="sd">        copy:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ring1</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">cons</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ring1</span><span class="p">)</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="c1"># Make a shallow copy of ring</span>
        <span class="n">ring1</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">varpts</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">bool_refpts</span><span class="p">([])</span>
        <span class="c1"># build the list of variable elements</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ElementVariable</span><span class="p">):</span>
                <span class="n">varpts</span> <span class="o">|=</span> <span class="n">ring</span><span class="o">.</span><span class="n">bool_refpts</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">refpts</span><span class="p">)</span>
        <span class="c1"># make a deep copy of all the variable elements</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">ring</span><span class="o">.</span><span class="n">uint32_refpts</span><span class="p">(</span><span class="n">varpts</span><span class="p">):</span>
            <span class="n">ring1</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">=</span> <span class="n">ring1</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ring1</span> <span class="o">=</span> <span class="n">ring</span>

    <span class="n">aaa</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ring1</span><span class="p">),</span> <span class="n">var</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
    <span class="n">vini</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">aaa</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">cini</span> <span class="o">=</span> <span class="p">[</span><span class="n">cst</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ring1</span><span class="p">)</span> <span class="k">for</span> <span class="n">cst</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">]</span>
    <span class="n">ntargets</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">cini</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ntargets</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;lm&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;trf&#39;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> constraints, </span><span class="si">{}</span><span class="s1"> variables, using method </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>
              <span class="nb">format</span><span class="p">(</span><span class="n">ntargets</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">),</span> <span class="n">method</span><span class="p">))</span>

    <span class="n">least_squares</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">vini</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">max_nfev</span><span class="o">=</span><span class="n">max_nfev</span><span class="p">,</span>
                  <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">diff_step</span><span class="o">=</span><span class="n">diff_step</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Constraints</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">cst</span><span class="p">,</span> <span class="n">ini</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">cini</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cst</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">ring1</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">ini</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">Variable</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">vini</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">vini</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">ring1</span><span class="p">,</span> <span class="n">vini</span><span class="o">=</span><span class="n">vini</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ring1</span></div>
</pre></div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, ATCollab.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.1.1.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>