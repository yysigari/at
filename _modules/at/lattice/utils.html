
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>at.lattice.utils &#8212; Accelerator Toolbox 0.0.4 documentation</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1e1de1a1873e13ef5536" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1e1de1a1873e13ef5536" rel="stylesheet">

  
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom_at.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1e1de1a1873e13ef5536">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/at/lattice/utils';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">

  
  
  
  
  
  
  

  
    <img src="../../../_static/AT.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../_static/AT.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="../../../common/indx.html">
                        AT basics
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../../p/index.html">
                        Python
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../../m/index.html">
                        Matlab
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" data-toggle="tooltip">
    <a class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="fa-regular fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/atcollab/at" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="../../../common/indx.html">
                        AT basics
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../../p/index.html">
                        Python
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../../m/index.html">
                        Matlab
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" data-toggle="tooltip">
    <a class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="fa-regular fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/atcollab/at" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <h1>Source code for at.lattice.utils</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Helper functions for working with AT lattices.</span>

<span class="sd">A lattice as understood by pyAT is a sequence of elements.  These functions</span>
<span class="sd">are useful for working with these sequences.</span>

<span class="sd">.. _refpts:</span>

<span class="sd">**Selecting elements in a lattice:**</span>

<span class="sd">The *refpts* argument allows functions to select locations in the lattice. The</span>
<span class="sd">location is defined as the entrance of the selected element. *refpts* may be:</span>

<span class="sd">#. an integer in the range *[-len(lattice), len(lattice)-1]*</span>
<span class="sd">   selecting an element according to the python indexing rules.</span>
<span class="sd">   As a special case, *len(lattice)* is allowed and refers to the end</span>
<span class="sd">   of the last element,</span>
<span class="sd">#. an ordered list of such integers without duplicates,</span>
<span class="sd">#. a numpy array of booleans of maximum length *len(lattice)+1*,</span>
<span class="sd">   where selected elements are :py:obj:`True`,</span>
<span class="sd">#. :py:obj:`None`, meaning an empty selection,</span>
<span class="sd">#. :py:obj:`.All`, meaning &quot;all possible reference points&quot;: the entrance of all</span>
<span class="sd">   elements plus the end of the last element,</span>
<span class="sd">#. :py:obj:`.End`, selecting the end of the last element,</span>
<span class="sd">#. an element type, selecting all the elements of that type in</span>
<span class="sd">   the lattice, e.g. :pycode:`at.Sextupole`,</span>
<span class="sd">#. a string, selecting all the elements whose `FamName` attribute matches it.</span>
<span class="sd">   Unix shell-style wildcards are accepted, e.g. `&quot;Q[FD]*&quot;`,</span>
<span class="sd">#. a callable :pycode:`filtfunc` such that :pycode:`filtfunc(elem)`</span>
<span class="sd">   is :py:obj:`True` for selected elements.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">compress</span>
<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Dipole</span>

<span class="n">_GEOMETRY_EPSIL</span> <span class="o">=</span> <span class="mf">1.0e-3</span>

<span class="n">ElementFilter</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Element</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>
<span class="n">BoolRefpts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="n">Uint32Refpts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="s1">&#39;End&#39;</span><span class="p">,</span> <span class="s1">&#39;AtError&#39;</span><span class="p">,</span> <span class="s1">&#39;AtWarning&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_descr&#39;</span><span class="p">,</span>
           <span class="s1">&#39;check_radiation&#39;</span><span class="p">,</span> <span class="s1">&#39;check_6d&#39;</span><span class="p">,</span>
           <span class="s1">&#39;set_radiation&#39;</span><span class="p">,</span> <span class="s1">&#39;set_6d&#39;</span><span class="p">,</span>
           <span class="s1">&#39;make_copy&#39;</span><span class="p">,</span> <span class="s1">&#39;uint32_refpts&#39;</span><span class="p">,</span> <span class="s1">&#39;bool_refpts&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_uint32_index&#39;</span><span class="p">,</span> <span class="s1">&#39;get_bool_index&#39;</span><span class="p">,</span>
           <span class="s1">&#39;checkattr&#39;</span><span class="p">,</span> <span class="s1">&#39;checktype&#39;</span><span class="p">,</span> <span class="s1">&#39;checkname&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_elements&#39;</span><span class="p">,</span> <span class="s1">&#39;get_s_pos&#39;</span><span class="p">,</span>
           <span class="s1">&#39;refpts_count&#39;</span><span class="p">,</span> <span class="s1">&#39;refpts_iterator&#39;</span><span class="p">,</span>
           <span class="s1">&#39;set_shift&#39;</span><span class="p">,</span> <span class="s1">&#39;set_tilt&#39;</span><span class="p">,</span> <span class="s1">&#39;set_rotation&#39;</span><span class="p">,</span>
           <span class="s1">&#39;tilt_elem&#39;</span><span class="p">,</span> <span class="s1">&#39;shift_elem&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate_elem&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_value_refpts&#39;</span><span class="p">,</span> <span class="s1">&#39;set_value_refpts&#39;</span><span class="p">,</span> <span class="s1">&#39;Refpts&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_geometry&#39;</span><span class="p">]</span>

<span class="n">_axis_def</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; [m]&quot;</span><span class="p">),</span>
    <span class="n">xp</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x&#39;&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; [rad]&quot;</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; [m]&quot;</span><span class="p">),</span>
    <span class="n">yp</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y&#39;&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; [rad]&quot;</span><span class="p">),</span>
    <span class="n">dp</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\delta$&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="n">ct</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\beta c \tau$&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot; [m]&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">vvv</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vv</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">_axis_def</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
    <span class="n">_axis_def</span><span class="p">[</span><span class="n">vvv</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vvv</span>


<div class="viewcode-block" id="AtError"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.AtError">[docs]</a><span class="k">class</span> <span class="nc">AtError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="AtWarning"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.AtWarning">[docs]</a><span class="k">class</span> <span class="nc">AtWarning</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="n">_typ1</span> <span class="o">=</span> <span class="s2">&quot;None, All, End, int, bool&quot;</span>

<span class="n">_typ2</span> <span class="o">=</span> <span class="s2">&quot;None, All, End, int, bool, str, Type[Element], ElementFilter&quot;</span>


<span class="k">class</span> <span class="nc">RefptsCode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">All</span> <span class="o">=</span> <span class="s1">&#39;All&#39;</span>
    <span class="n">End</span> <span class="o">=</span> <span class="s1">&#39;End&#39;</span>


<span class="n">RefIndex</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">RefptsCode</span><span class="p">]</span>
<span class="n">Refpts</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">Element</span><span class="p">,</span> <span class="n">ElementFilter</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">RefIndex</span><span class="p">]</span>


<span class="c1">#: :py:obj:`All` is a special value to be used as *refpts*. It means</span>
<span class="c1">#: &quot;all possible reference points&quot;: the entrance of all elements plus the end</span>
<span class="c1">#: of the last element.</span>
<span class="n">All</span> <span class="o">=</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">All</span>

<span class="c1">#: :py:obj:`End` is a special value to be used as *refpts*. It refers to the</span>
<span class="c1">#: end of the last element.</span>
<span class="n">End</span> <span class="o">=</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">End</span>


<span class="k">def</span> <span class="nf">_type_error</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">refpts</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="k">return</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;Invalid refpts type </span><span class="si">{0}</span><span class="s2">. Allowed types: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">types</span><span class="p">))</span>


<span class="c1"># noinspection PyIncorrectDocstring</span>
<div class="viewcode-block" id="axis_descr"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.axis_descr">[docs]</a><span class="k">def</span> <span class="nf">axis_descr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;axis_descr(axis [ ,axis], key=None)</span>

<span class="sd">    Return a tuple containing for each input argument the requested information</span>

<span class="sd">    Parameters:</span>
<span class="sd">        axis (Union[int, str]):    either an index in 0:6 or a string in</span>
<span class="sd">          [&#39;x&#39;, &#39;xp&#39;, &#39;y&#39;, &#39;yp&#39;, &#39;dp&#39;, &#39;ct&#39;]</span>
<span class="sd">        key:                        key in the coordinate description</span>
<span class="sd">          dictionary, selecting the desired information. One of :</span>

<span class="sd">          &#39;index&#39;</span>
<span class="sd">            index in the standard AT coordinate vector</span>
<span class="sd">          &#39;label&#39;</span>
<span class="sd">            label for plot annotation</span>
<span class="sd">          &#39;unit&#39;</span>
<span class="sd">            coordinate unit</span>
<span class="sd">          :py:obj:`None`</span>
<span class="sd">            entire description dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">        descr (Tuple): requested information for each input argument.</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; axis_descr(&#39;x&#39;,&#39;dp&#39;, key=&#39;index&#39;)</span>
<span class="sd">        (0, 4)</span>

<span class="sd">        returns the indices in the standard coordinate vector</span>

<span class="sd">        &gt;&gt;&gt; dplabel, = axis_descr(&#39;dp&#39;, key=&#39;label&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(dplabel)</span>
<span class="sd">        $\delta$</span>

<span class="sd">        returns the coordinate label for plot annotation</span>

<span class="sd">        &gt;&gt;&gt; axis_descr(&#39;x&#39;,&#39;dp&#39;)</span>
<span class="sd">        ({&#39;index&#39;: 0, &#39;label&#39;: &#39;x&#39;, &#39;unit&#39;: &#39; [m]&#39;},</span>
<span class="sd">         {&#39;index&#39;: 4, &#39;label&#39;: &#39;$\\delta$&#39;, &#39;unit&#39;: &#39;&#39;})</span>

<span class="sd">        returns the entire description directories</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_axis_def</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_axis_def</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">check_radiation</span><span class="p">(</span><span class="n">rad</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Deprecated decorator for optics functions (see :py:func:`check_6d`).</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">check_6d</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_radiation</span><span class="p">(</span><span class="n">rad</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Deprecated decorator for optics functions (see :py:func:`set_6d`).</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">set_6d</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>


<div class="viewcode-block" id="check_6d"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.check_6d">[docs]</a><span class="k">def</span> <span class="nf">check_6d</span><span class="p">(</span><span class="n">is_6d</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Decorator for optics functions</span>

<span class="sd">    Wraps a function like :pycode:`func(ring, *args, **kwargs)` where</span>
<span class="sd">    :pycode:`ring` is a :py:class:`.Lattice` object. Raise :py:class:`.AtError`</span>
<span class="sd">    if :pycode:`ring.is_6d` is not the desired *is_6d* state. No test is</span>
<span class="sd">    performed if :pycode:`ring` is not a :py:class:`.Lattice`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        is_6d: Desired 6D state</span>

<span class="sd">    Raises:</span>
<span class="sd">        AtError: if :pycode:`ring.is_6d` is not *is_6d*</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; @check_6d(False)</span>
<span class="sd">        ... def find_orbit4(ring, dct=None, guess=None, **kwargs):</span>
<span class="sd">                ...</span>

<span class="sd">        Raises :py:class:`.AtError` if :pycode:`ring.is_6d` is :py:obj:`True`</span>

<span class="sd">    See Also:</span>
<span class="sd">        :py:func:`set_6d`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">radiation_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">ringrad</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="s1">&#39;is_6d&#39;</span><span class="p">,</span> <span class="n">is_6d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ringrad</span> <span class="o">!=</span> <span class="n">is_6d</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AtError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> needs &quot;ring.is_6d&quot; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">is_6d</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">radiation_decorator</span></div>


<div class="viewcode-block" id="set_6d"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.set_6d">[docs]</a><span class="k">def</span> <span class="nf">set_6d</span><span class="p">(</span><span class="n">is_6d</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Decorator for optics functions</span>

<span class="sd">    Wraps a function like :pycode:`func(ring, *args, **kwargs)` where</span>
<span class="sd">    :pycode:`ring` is a :py:class:`.Lattice` object. If :pycode:`ring.is_6d`</span>
<span class="sd">    is not the desired *is_6d* state, :pycode:`func()` will be called with a</span>
<span class="sd">    modified copy of :pycode:`ring` satisfying the *is_6d* state.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        is_6d: Desired 6D state</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; @set_6d(True)</span>
<span class="sd">        ... def compute(ring)</span>
<span class="sd">                ...</span>

<span class="sd">        is roughly equivalent to:</span>

<span class="sd">        &gt;&gt;&gt; if ring.is_6d:</span>
<span class="sd">        ...     compute(ring)</span>
<span class="sd">        ... else:</span>
<span class="sd">        ...     compute(ring.enable_6d(copy=True))</span>

<span class="sd">        See Also:</span>
<span class="sd">            :py:func:`check_6d`, :py:meth:`.Lattice.enable_6d`,</span>
<span class="sd">            :py:meth:`.Lattice.disable_6d`</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_6d</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">setrad_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">rg</span> <span class="o">=</span> <span class="n">ring</span> <span class="k">if</span> <span class="n">ring</span><span class="o">.</span><span class="n">is_6d</span> <span class="k">else</span> <span class="n">ring</span><span class="o">.</span><span class="n">enable_6d</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">setrad_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">rg</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">disable_6d</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">ring</span><span class="o">.</span><span class="n">is_6d</span> <span class="k">else</span> <span class="n">ring</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">setrad_decorator</span></div>


<div class="viewcode-block" id="make_copy"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.make_copy">[docs]</a><span class="k">def</span> <span class="nf">make_copy</span><span class="p">(</span><span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Decorator for optics functions</span>

<span class="sd">    Wraps a function like :pycode:`func(ring, refpts, *args, **kwargs)` where</span>
<span class="sd">    :pycode:`ring` is a :py:class:`.Lattice` object.</span>

<span class="sd">    If *copy* is :py:obj:`False`, the function is not modified,</span>

<span class="sd">    If *copy* is :py:obj:`True`, a shallow copy of :pycode:`ring` is done,</span>
<span class="sd">    then the elements selected by *refpts* are deep-copied, then :pycode:`func`</span>
<span class="sd">    is applied to the copy, and the new :pycode:`ring` is returned.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        copy:   If :py:obj:`True`, apply the decorated function to a copy of</span>
<span class="sd">          :pycode:`ring`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">copy_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">ring</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
                <span class="n">func</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ring</span>
            <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">copy_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">copy_decorator</span></div>


<div class="viewcode-block" id="uint32_refpts"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.uint32_refpts">[docs]</a><span class="k">def</span> <span class="nf">uint32_refpts</span><span class="p">(</span><span class="n">refpts</span><span class="p">:</span> <span class="n">RefIndex</span><span class="p">,</span> <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                  <span class="n">endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">types</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_typ1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Uint32Refpts</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a :py:obj:`~numpy.uint32` array of element indices selecting</span>
<span class="sd">    ring elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        refpts:     Element selector. *refpts* may be:</span>

<span class="sd">          #. an integer or a sequence of integers</span>
<span class="sd">             (0 indicating the first element),</span>
<span class="sd">          #. a sequence of booleans marking the selected elements,</span>
<span class="sd">          #. :py:obj:`None`, meaning empty selection,</span>
<span class="sd">          #. :py:obj:`.All`, meaning &quot;all possible reference points&quot;,</span>
<span class="sd">          #. :py:obj:`.End`, selecting the end of the last element.</span>
<span class="sd">        n_elements: Length of the sequence of elements</span>
<span class="sd">        endpoint:   if :py:obj:`True`, allow *n_elements* as a</span>
<span class="sd">          special index, referring to the end of the last element.</span>
<span class="sd">        types:      Allowed types</span>

<span class="sd">    Returns:</span>
<span class="sd">        uint32_ref (Uint32Refpts):  :py:obj:`~numpy.uint32` numpy array used</span>
<span class="sd">          for indexing :py:class:`.Element`\ s in a lattice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">All</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">n_elements</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="n">n_elements</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">End</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;&quot;End&quot; index out of range&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n_elements</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">refpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">refs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>

        <span class="c1"># Handle negative indices</span>
        <span class="k">if</span> <span class="n">endpoint</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n_elements</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_elements</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">%</span> <span class="n">n_elements</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="c1"># Check ascending</span>
        <span class="k">if</span> <span class="n">refs</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">refs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">nxt</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">nxt</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Index out of range or not in ascending&#39;</span>
                                     <span class="s1">&#39; order&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">nxt</span> <span class="o">==</span> <span class="n">prev</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Duplicated index&#39;</span><span class="p">)</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">nxt</span>

        <span class="k">return</span> <span class="n">refs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">_type_error</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span></div>


<span class="c1"># noinspection PyIncorrectDocstring</span>
<div class="viewcode-block" id="get_uint32_index"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.get_uint32_index">[docs]</a><span class="k">def</span> <span class="nf">get_uint32_index</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span>
                     <span class="n">endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Uint32Refpts</span><span class="p">:</span>
    <span class="c1"># noinspection PyUnresolvedReferences, PyShadowingNames</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns an integer array of element indices, selecting ring elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        refpts:         Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        endpoint:   if :py:obj:`True`, allow *len(ring)* as a</span>
<span class="sd">          special index, referring to the end of the last element.</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        uint32_ref (Uint32Refpts): uint32 numpy array used for indexing</span>
<span class="sd">          :py:class:`.Element`\ s in a lattice.</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; get_uint32_index(ring, at.Sextupole)</span>
<span class="sd">        array([ 21,  27,  35,  89,  97, 103], dtype=uint32)</span>

<span class="sd">        numpy array of indices of all :py:class:`.Sextupole`\ s</span>

<span class="sd">        &gt;&gt;&gt; get_uint32_index(ring, at.End)</span>
<span class="sd">        array([121], dtype=uint32)</span>

<span class="sd">        numpy array([:pycode:`len(ring)+1`])</span>

<span class="sd">        &gt;&gt;&gt; get_uint32_index(ring, at.checkattr(&#39;Frequency&#39;))</span>
<span class="sd">        array([0], dtype=uint32)</span>

<span class="sd">        numpy array of indices of all elements having a &#39;Frequency&#39;</span>
<span class="sd">        attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refpts</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">refpts</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">refpts</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checkname</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">uint32_refpts</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">_typ2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="k">if</span> <span class="n">checkfun</span><span class="p">(</span><span class="n">el</span><span class="p">)),</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span></div>


<div class="viewcode-block" id="bool_refpts"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.bool_refpts">[docs]</a><span class="k">def</span> <span class="nf">bool_refpts</span><span class="p">(</span><span class="n">refpts</span><span class="p">:</span> <span class="n">RefIndex</span><span class="p">,</span> <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">types</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_typ1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolRefpts</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a :py:class:`bool` array of element indices, selecting ring</span>
<span class="sd">    elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        refpts:     Element selector. *refpts* may be:</span>

<span class="sd">          #. an integer or a sequence of integers</span>
<span class="sd">             (0 indicating the first element),</span>
<span class="sd">          #. a sequence of booleans marking the selected elements,</span>
<span class="sd">          #. :py:obj:`None`, meaning empty selection,</span>
<span class="sd">          #. :py:obj:`.All`, meaning &quot;all possible reference points&quot;,</span>
<span class="sd">          #. :py:obj:`.End`, selecting the end of the last element.</span>
<span class="sd">        n_elements: Length of the lattice</span>
<span class="sd">        endpoint:   if :py:obj:`True`, allow *n_elements* as a</span>
<span class="sd">          special index, referring to the end of the last element.</span>
<span class="sd">        types:      Allowed types</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool_refs (BoolRefpts):  A bool numpy array used for indexing</span>
<span class="sd">          :py:class:`.Element`\ s in a lattice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">n_elements</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="n">n_elements</span>
    <span class="k">if</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">All</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">End</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;&quot;End&quot; index out of range&#39;</span><span class="p">)</span>
        <span class="n">brefpts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">brefpts</span><span class="p">[</span><span class="n">n_elements</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">brefpts</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">refpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">refs</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">refs</span><span class="p">[:</span><span class="n">stop</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="n">brefpts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">brefpts</span><span class="p">[</span><span class="n">refs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">brefpts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">_type_error</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span></div>


<span class="c1"># noinspection PyIncorrectDocstring</span>
<div class="viewcode-block" id="get_bool_index"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.get_bool_index">[docs]</a><span class="k">def</span> <span class="nf">get_bool_index</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span>
                   <span class="n">endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoolRefpts</span><span class="p">:</span>
    <span class="c1"># noinspection PyUnresolvedReferences, PyShadowingNames</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a bool array of element indices, selecting ring elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        refpts:         Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        endpoint:   if :py:obj:`True`, allow *len(ring)* as a</span>
<span class="sd">          special index, referring to the end of the last element.</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool_refs (BoolRefpts):  A bool numpy array used for indexing</span>
<span class="sd">          :py:class:`.Element`\ s in a lattice.</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; refpts = get_bool_index(ring, at.Quadrupole)</span>

<span class="sd">        Returns a numpy array of booleans where all :py:class:`.Quadrupole`</span>
<span class="sd">        are :py:obj:`True`</span>

<span class="sd">        &gt;&gt;&gt; refpts = get_bool_index(ring, &quot;Q[FD]*&quot;)</span>

<span class="sd">        Returns a numpy array of booleans where all elements whose *FamName*</span>
<span class="sd">        matches &quot;Q[FD]*&quot; are :py:obj:`True`</span>

<span class="sd">        &gt;&gt;&gt; refpts = get_bool_index(ring, at.checkattr(&#39;K&#39;, 0.0))</span>

<span class="sd">        Returns a numpy array of booleans where all elements whose *K*</span>
<span class="sd">        attribute is 0.0 are :py:obj:`True`</span>

<span class="sd">        &gt;&gt;&gt; refpts = get_bool_index(ring, None)</span>

<span class="sd">        Returns a numpy array of *len(ring)+1* :py:obj:`False` values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refpts</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">refpts</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">refpts</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checkname</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bool_refpts</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">_typ2</span><span class="p">)</span>

    <span class="n">boolrefs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">checkfun</span><span class="p">,</span> <span class="n">ring</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">endpoint</span><span class="p">:</span>
        <span class="n">boolrefs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boolrefs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">boolrefs</span></div>


<div class="viewcode-block" id="checkattr"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.checkattr">[docs]</a><span class="k">def</span> <span class="nf">checkattr</span><span class="p">(</span><span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrvalue</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">ElementFilter</span><span class="p">:</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checks the presence or the value of an attribute</span>

<span class="sd">    Returns a function to be used as an :py:class:`.Element` filter, which</span>
<span class="sd">    checks the presence or the value of an attribute of the</span>
<span class="sd">    provided :py:class:`.Element`.</span>
<span class="sd">    This function can be used to extract from a ring all elements</span>
<span class="sd">    having a given attribute.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        attrname: Attribute name</span>
<span class="sd">        attrvalue: Attribute value. If absent, the returned function checks</span>
<span class="sd">          the presence of an *attrname* attribute. If present, the</span>
<span class="sd">          returned function checks if :pycode:`attrname == attrvalue`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        checkfun (ElementFilter):   Element filter function</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; cavs = filter(checkattr(&#39;Frequency&#39;), ring)</span>

<span class="sd">        Returns an iterator over all elements in *ring* that have a</span>
<span class="sd">        :pycode:`Frequency` attribute</span>

<span class="sd">        &gt;&gt;&gt; elts = filter(checkattr(&#39;K&#39;, 0.0), ring)</span>

<span class="sd">        Returns an iterator over all elements in ring that have a</span>
<span class="sd">        :pycode:`K` attribute equal to 0.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">testf</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">attrvalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">attrvalue</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">testf</span></div>


<div class="viewcode-block" id="checktype"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.checktype">[docs]</a><span class="k">def</span> <span class="nf">checktype</span><span class="p">(</span><span class="n">eltype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ElementFilter</span><span class="p">:</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checks the type of an element</span>

<span class="sd">    Returns a function to be used as an :py:class:`.Element` filter, which</span>
<span class="sd">    checks the type of the provided :py:class:`.Element`.</span>
<span class="sd">    This function can be used to extract from a ring all elements</span>
<span class="sd">    having a given type.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        eltype: Desired :py:class:`.Element` type</span>

<span class="sd">    Returns:</span>
<span class="sd">        checkfun (ElementFilter):   Element filter function</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; qps = filter(checktype(at.Quadrupole), ring)</span>

<span class="sd">        Returns an iterator over all quadrupoles in ring</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">eltype</span><span class="p">)</span></div>


<div class="viewcode-block" id="checkname"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.checkname">[docs]</a><span class="k">def</span> <span class="nf">checkname</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementFilter</span><span class="p">:</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checks the name of an element</span>

<span class="sd">    Returns a function to be used as an :py:class:`.Element` filter,</span>
<span class="sd">    which checks the name of the provided :py:class:`.Element`.</span>
<span class="sd">    This function can be used to extract from a ring all elements</span>
<span class="sd">    having a given name.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        pattern: Desired :py:class:`.Element` name. Unix shell-style</span>
<span class="sd">          wildcards are supported (see :py:func:`fnmatch.fnmatch`)</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        checkfun (ElementFilter):   Element filter function</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; qps = filter(checkname(&#39;QF*&#39;), ring)</span>

<span class="sd">        Returns an iterator over all with name starting with ``QF``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
        <span class="n">rgx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">rgx</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">FamName</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">FamName</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span></div>


<div class="viewcode-block" id="refpts_iterator"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.refpts_iterator">[docs]</a><span class="k">def</span> <span class="nf">refpts_iterator</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Element</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return an iterator over selected elements in a lattice</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:           Lattice description</span>
<span class="sd">        refpts:         Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        elem_iter (Iterator[Element]):  Iterator over the elements in *ring*</span>
<span class="sd">          selected by *refpts*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refpts</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">refpts</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">refpts</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checkname</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">All</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">End</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;&quot;End&quot; is not allowed for endpoint=False&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">refpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">compress</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_type_error</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">_typ2</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="n">checkfun</span><span class="p">,</span> <span class="n">ring</span><span class="p">)</span></div>


<span class="c1"># noinspection PyUnusedLocal,PyIncorrectDocstring</span>
<div class="viewcode-block" id="refpts_count"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.refpts_count">[docs]</a><span class="k">def</span> <span class="nf">refpts_count</span><span class="p">(</span><span class="n">refpts</span><span class="p">:</span> <span class="n">RefIndex</span><span class="p">,</span> <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">types</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_typ1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the number of reference points</span>

<span class="sd">    Parameters:</span>
<span class="sd">        refpts:     refpts may be:</span>

<span class="sd">          #. an integer or a sequence of integers</span>
<span class="sd">             (0 indicating the first element),</span>
<span class="sd">          #. a sequence of booleans marking the selected elements,</span>
<span class="sd">          #. :py:obj:`None`, meaning empty selection,</span>
<span class="sd">          #. :py:obj:`.All`, meaning &quot;all possible reference points&quot;,</span>
<span class="sd">          #. :py:obj:`.End`, selecting the end of the last element.</span>
<span class="sd">        n_elements: Lattice length</span>
<span class="sd">        endpoint:   if :py:obj:`True`, allow *n_elements* as a</span>
<span class="sd">          special index, referring to the end of the last element.</span>

<span class="sd">    Returns:</span>
<span class="sd">        nrefs (int):  The number of reference points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">All</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n_elements</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="n">n_elements</span>
    <span class="k">elif</span> <span class="n">refpts</span> <span class="ow">is</span> <span class="n">RefptsCode</span><span class="o">.</span><span class="n">End</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;&quot;End&quot; index out of range&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">refpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">refs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">refs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">refs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">_type_error</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_refcount</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span>
              <span class="n">endpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># noinspection PyUnresolvedReferences, PyShadowingNames</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the number of reference points</span>

<span class="sd">    Parameters:</span>
<span class="sd">        refpts:         Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        endpoint:   if :py:obj:`True`, allow *len(ring)* as a</span>
<span class="sd">          special index, referring to the end of the last element.</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        nrefs (int):  The number of reference points</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; refpts = ring.refcount(at.Sextupole)</span>
<span class="sd">        6</span>

<span class="sd">        Returns the number of :py:class:`.Sextupole`\ s in the lattice</span>

<span class="sd">        &gt;&gt;&gt; refpts = ring.refcount(at.All)</span>
<span class="sd">        122</span>

<span class="sd">        Returns *len(ring)+1*</span>

<span class="sd">        &gt;&gt;&gt; refpts = ring.refcount(at.All, endpoint=False)</span>
<span class="sd">        121</span>

<span class="sd">        Returns *len(ring)*</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="n">refpts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">refpts</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">refpts</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">Element</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checktype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">refpts</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">checkfun</span> <span class="o">=</span> <span class="n">checkname</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">refpts_count</span><span class="p">(</span><span class="n">refpts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">_typ2</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">checkfun</span><span class="p">,</span> <span class="n">ring</span><span class="p">)))</span>


<span class="c1"># noinspection PyUnusedLocal,PyIncorrectDocstring</span>
<div class="viewcode-block" id="get_elements"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.get_elements">[docs]</a><span class="k">def</span> <span class="nf">get_elements</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a list of elements selected by *key*.</span>

<span class="sd">    Deprecated: :pycode:`get_elements(ring, refpts)` is :pycode:`ring[refpts]`</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:           Lattice description</span>
<span class="sd">        refpts:         Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        elem_list (list):  list of :py:class:`.Element`\ s matching key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">refpts_iterator</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_value_refpts"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.get_value_refpts">[docs]</a><span class="k">def</span> <span class="nf">get_value_refpts</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span>
                     <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Extracts attribute values from selected</span>
<span class="sd">        lattice :py:class:`.Element`\ s.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:           Lattice description</span>
<span class="sd">        refpts:         Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        attrname:   Attribute name</span>
<span class="sd">        index:      index of the value to retrieve if *attrname* is</span>
<span class="sd">          an array. If :py:obj:`None` the full array is retrieved</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        attrvalues: numpy Array of attribute values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">getf</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">getf</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">getf</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">refpts_iterator</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span>
                                                               <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)])</span></div>


<div class="viewcode-block" id="set_value_refpts"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.set_value_refpts">[docs]</a><span class="k">def</span> <span class="nf">set_value_refpts</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span><span class="p">,</span>
                     <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrvalues</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">increment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set the values of an attribute of an array of elements based on</span>
<span class="sd">    their refpts</span>


<span class="sd">    Parameters:</span>
<span class="sd">        ring:       Lattice description</span>
<span class="sd">        refpts:         Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        attrname:   Attribute name</span>
<span class="sd">        attrvalues: Attribute values</span>
<span class="sd">        index:      index of the value to set if *attrname* is</span>
<span class="sd">          an array. if :py:obj:`None`, the full array is replaced by</span>
<span class="sd">          *attrvalue*</span>
<span class="sd">        increment:  If :py:obj:`True`, *attrvalues* are added to the initial values.</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>
<span class="sd">        copy:       If :py:obj:`False`, the modification is done in-place,</span>

<span class="sd">          If :py:obj:`True`, return a shallow copy of the lattice. Only the</span>
<span class="sd">          modified elements are copied.</span>

<span class="sd">          .. Caution::</span>

<span class="sd">             a shallow copy means that all non-modified</span>
<span class="sd">             elements are shared with the original lattice.</span>
<span class="sd">             Any further modification will affect both lattices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">setf</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">setf</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">increment</span><span class="p">:</span>
        <span class="n">attrvalues</span> <span class="o">+=</span> <span class="n">get_value_refpts</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span>
                                       <span class="n">attrname</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attrvalues</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">attrvalues</span><span class="p">,</span>
                                        <span class="p">(</span><span class="n">_refcount</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">),))</span>

    <span class="c1"># noinspection PyShadowingNames</span>
    <span class="nd">@make_copy</span><span class="p">(</span><span class="n">copy</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elm</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">refpts_iterator</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">),</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">setf</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">apply</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">attrvalues</span><span class="p">,</span> <span class="n">regex</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_s_pos"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.get_s_pos">[docs]</a><span class="k">def</span> <span class="nf">get_s_pos</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span> <span class="o">=</span> <span class="n">All</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the locations of selected elements</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:       Lattice description</span>
<span class="sd">        refpts:     Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        s_pos:  Array of locations of the elements selected by *refpts*</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; get_s_pos(ring, at.End)</span>
<span class="sd">        array([26.37428795])</span>

<span class="sd">        Position at the end of the last element: length of the lattice</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># Positions at the end of each element.</span>
    <span class="n">s_pos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="s1">&#39;Length&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">])</span>
    <span class="c1"># Prepend position at the start of the first element.</span>
    <span class="n">s_pos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">s_pos</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s_pos</span><span class="p">[</span><span class="n">get_bool_index</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)]</span></div>


<div class="viewcode-block" id="rotate_elem"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.rotate_elem">[docs]</a><span class="k">def</span> <span class="nf">rotate_elem</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">tilt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="n">yaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">relative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set the tilt, pitch and yaw angle of an :py:class:`.Element`.</span>
<span class="sd">    The tilt is a rotation around the *s*-axis, the pitch is a</span>
<span class="sd">    rotation around the *x*-axis and the yaw is a rotation around</span>
<span class="sd">    the *y*-axis.</span>
<span class="sd">    A positive angle represent a clockwise rotation when looking in</span>
<span class="sd">    the direction of the rotation axis.</span>

<span class="sd">    The transformations are not all commmutative, the tilt is always the</span>
<span class="sd">    last transformation applied.</span>

<span class="sd">    If *relative* is :py:obj:`True`, the previous angle and shifts are</span>
<span class="sd">    rebuilt form the *R* and *T* matrix and incremented by the input arguments.</span>

<span class="sd">    The shift is always conserved regardless of the value of *relative*.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        elem:           Element to be tilted</span>
<span class="sd">        tilt:           Tilt angle [rad]</span>
<span class="sd">        pitch:          Pitch angle [rad]</span>
<span class="sd">        yaw:            Yaw angle [rad]</span>
<span class="sd">        relative:       If :py:obj:`True`, the rotation is added to the</span>
<span class="sd">          previous one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyShadowingNames</span>
    <span class="k">def</span> <span class="nf">_get_rm_tv</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">):</span>
        <span class="n">tilt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">tilt</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">yaw</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">yaw</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ct</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tilt</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span>
        <span class="n">ap</span><span class="p">,</span> <span class="n">ay</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">le</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">le</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>
        <span class="n">rr1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">ct</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]))</span>
        <span class="n">rr1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="n">rr1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="n">rr1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">st</span>
        <span class="n">rr1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">st</span>
        <span class="n">rr2</span> <span class="o">=</span> <span class="n">rr1</span><span class="o">.</span><span class="n">T</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ay</span><span class="p">,</span> <span class="o">-</span><span class="n">yaw</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="o">-</span><span class="n">pitch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ay</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">rt1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">rt1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rt1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">rt2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">rt2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="o">*</span><span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rt2</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="o">*</span><span class="n">t2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rr1</span> <span class="o">@</span> <span class="n">rt1</span><span class="p">,</span> <span class="n">rt2</span> <span class="o">@</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

    <span class="n">tilt0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pitch0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">yaw0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t10</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">t20</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">):</span>
        <span class="n">rr10</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">rr10</span><span class="p">[:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">R1</span><span class="p">[:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">rt10</span> <span class="o">=</span> <span class="n">rr10</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">elem</span><span class="o">.</span><span class="n">R1</span>
        <span class="n">tilt0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">rr10</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">rr10</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">yaw0</span> <span class="o">=</span> <span class="o">-</span><span class="n">rt10</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">rr10</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">pitch0</span> <span class="o">=</span> <span class="o">-</span><span class="n">rt10</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">rr10</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">t10</span><span class="p">,</span> <span class="n">t20</span> <span class="o">=</span> <span class="n">_get_rm_tv</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">tilt0</span><span class="p">,</span> <span class="n">pitch0</span><span class="p">,</span> <span class="n">yaw0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;T1&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;T2&#39;</span><span class="p">):</span>
        <span class="n">t10</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">T1</span><span class="o">-</span><span class="n">t10</span>
        <span class="n">t20</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">T2</span><span class="o">-</span><span class="n">t20</span>
    <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
        <span class="n">tilt</span> <span class="o">+=</span> <span class="n">tilt0</span>
        <span class="n">pitch</span> <span class="o">+=</span> <span class="n">pitch0</span>
        <span class="n">yaw</span> <span class="o">+=</span> <span class="n">yaw0</span>

    <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">_get_rm_tv</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">)</span>
    <span class="n">elem</span><span class="o">.</span><span class="n">R1</span> <span class="o">=</span> <span class="n">r1</span>
    <span class="n">elem</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="n">r2</span>
    <span class="n">elem</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">+</span><span class="n">t10</span>
    <span class="n">elem</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="n">t2</span><span class="o">+</span><span class="n">t20</span></div>


<div class="viewcode-block" id="tilt_elem"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.tilt_elem">[docs]</a><span class="k">def</span> <span class="nf">tilt_elem</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">rots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">relative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set the tilt angle :math:`\theta` of an :py:class:`.Element`</span>

<span class="sd">    The rotation matrices are stored in the :pycode:`R1` and :pycode:`R2`</span>
<span class="sd">    attributes.</span>

<span class="sd">    :math:`R_1=\begin{pmatrix} cos\theta &amp; sin\theta \\</span>
<span class="sd">    -sin\theta &amp; cos\theta \end{pmatrix}`,</span>
<span class="sd">    :math:`R_2=\begin{pmatrix} cos\theta &amp; -sin\theta \\</span>
<span class="sd">    sin\theta &amp; cos\theta \end{pmatrix}`</span>

<span class="sd">    Parameters:</span>
<span class="sd">        elem:           Element to be tilted</span>
<span class="sd">        rots:           Tilt angle :math:`\theta` [rd]. *rots* &gt; 0 corresponds</span>
<span class="sd">          to a corkscrew rotation of the element looking in the direction of</span>
<span class="sd">          the beam</span>
<span class="sd">        relative:       If :py:obj:`True`, the rotation is added to the</span>
<span class="sd">          existing one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rotate_elem</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="n">rots</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="n">relative</span><span class="p">)</span></div>


<div class="viewcode-block" id="shift_elem"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.shift_elem">[docs]</a><span class="k">def</span> <span class="nf">shift_elem</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">deltax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">deltaz</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
               <span class="n">relative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sets the transverse displacement of an :py:class:`.Element`</span>

<span class="sd">    The translation vectors are stored in the :pycode:`T1` and :pycode:`T2`</span>
<span class="sd">    attributes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        elem:           Element to be shifted</span>
<span class="sd">        deltax:         Horizontal displacement [m]</span>
<span class="sd">        deltaz:         Vertical displacement [m]</span>
<span class="sd">        relative:       If :py:obj:`True`, the translation is added to the</span>
<span class="sd">          existing one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">deltax</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">deltaz</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">relative</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;T1&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s1">&#39;T2&#39;</span><span class="p">):</span>
        <span class="n">elem</span><span class="o">.</span><span class="n">T1</span> <span class="o">-=</span> <span class="n">tr</span>
        <span class="n">elem</span><span class="o">.</span><span class="n">T2</span> <span class="o">+=</span> <span class="n">tr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">elem</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="o">-</span><span class="n">tr</span>
        <span class="n">elem</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="n">tr</span></div>


<div class="viewcode-block" id="set_rotation"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.set_rotation">[docs]</a><span class="k">def</span> <span class="nf">set_rotation</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">tilts</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">pitches</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yaws</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sets the tilts of a list of elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:           Lattice description</span>
<span class="sd">        tilts:          Sequence of tilt values as long as ring or</span>
<span class="sd">          scalar tilt value applied to all elements, default=0</span>
<span class="sd">        pitches:          Sequence of pitch values as long as ring or</span>
<span class="sd">          scalar tilt value applied to all elements, default=0</span>
<span class="sd">        yaws:          Sequence of yaw values as long as ring or</span>
<span class="sd">          scalar tilt value applied to all elements, default=0</span>
<span class="sd">        relative:       If :py:obj:`True`, the rotations are added to the</span>
<span class="sd">          existing ones</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tilts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">tilts</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),))</span>
    <span class="n">pitches</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">pitches</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),))</span>
    <span class="n">yaws</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">yaws</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">tilts</span><span class="p">,</span> <span class="n">pitches</span><span class="p">,</span> <span class="n">yaws</span><span class="p">):</span>
        <span class="n">rotate_elem</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="n">tilt</span><span class="p">,</span> <span class="n">pitch</span><span class="o">=</span><span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="o">=</span><span class="n">yaw</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="n">relative</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_tilt"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.set_tilt">[docs]</a><span class="k">def</span> <span class="nf">set_tilt</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">tilts</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sets the tilts of a list of elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:           Lattice description</span>
<span class="sd">        tilts:          Sequence of tilt values as long as ring or</span>
<span class="sd">          scalar tilt value applied to all elements</span>
<span class="sd">        relative:       If :py:obj:`True`, the rotation is added to the</span>
<span class="sd">          existing one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tilts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">tilts</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">tilt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">tilts</span><span class="p">):</span>
        <span class="n">tilt_elem</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="n">relative</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_shift"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.set_shift">[docs]</a><span class="k">def</span> <span class="nf">set_shift</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span> <span class="n">dxs</span><span class="p">,</span> <span class="n">dzs</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Sets the translations of a list of elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:           Lattice description</span>
<span class="sd">        dxs:            Sequence of horizontal displacements values as long as</span>
<span class="sd">          ring or scalar value applied to all elements [m]</span>
<span class="sd">        dzs:            Sequence of vertical displacements values as long as</span>
<span class="sd">          ring or scalar value applied to all elements [m]</span>
<span class="sd">        relative:       If :py:obj:`True`, the displacement is added to the</span>
<span class="sd">          existing one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dxs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">dxs</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),))</span>
    <span class="n">dzs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">dzs</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dxs</span><span class="p">,</span> <span class="n">dzs</span><span class="p">):</span>
        <span class="n">shift_elem</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="n">relative</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_geometry"><a class="viewcode-back" href="../../../p/api/at.lattice.utils.html#at.lattice.utils.get_geometry">[docs]</a><span class="k">def</span> <span class="nf">get_geometry</span><span class="p">(</span><span class="n">ring</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Element</span><span class="p">],</span>
                 <span class="n">refpts</span><span class="p">:</span> <span class="n">Refpts</span> <span class="o">=</span> <span class="n">All</span><span class="p">,</span>
                 <span class="n">start_coordinates</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                 <span class="n">centered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                 <span class="p">):</span>
    <span class="c1"># noinspection PyShadowingNames</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute the 2D ring geometry in cartesian coordinates</span>

<span class="sd">    Parameters:</span>
<span class="sd">        ring:               Lattice description.</span>
<span class="sd">        refpts:     Element selection key.</span>
<span class="sd">          See &quot;:ref:`Selecting elements in a lattice &lt;refpts&gt;`&quot;</span>
<span class="sd">        start_coordinates:  *x*, *y*, *angle* at starting point. *x* and *y* are</span>
<span class="sd">          ignored if *centered* is :py:obj:`True`.</span>
<span class="sd">        centered:           if :py:obj:`True` the coordinates origin is the</span>
<span class="sd">          center of the ring.</span>
<span class="sd">        regex: Use regular expression for *refpts* string matching instead of</span>
<span class="sd">          Unix shell-style wildcards.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geomdata:           recarray containing, x, y, angle.</span>
<span class="sd">        radius:             machine radius at the beginning of the lattice.</span>

<span class="sd">            .. attention::</span>
<span class="sd">               This radius is different from the radius usually defined as</span>
<span class="sd">               :math:`C/2\pi`</span>

<span class="sd">    Example:</span>

<span class="sd">       &gt;&gt;&gt; geomdata, radius = get_geometry(ring)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">geom_dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                  <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                  <span class="p">(</span><span class="s2">&quot;angle&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)]</span>
    <span class="n">boolrefs</span> <span class="o">=</span> <span class="n">get_bool_index</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">refpts</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span>
    <span class="n">nrefs</span> <span class="o">=</span> <span class="n">refpts_count</span><span class="p">(</span><span class="n">boolrefs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
    <span class="n">geomdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">recarray</span><span class="p">((</span><span class="n">nrefs</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">geom_dtype</span><span class="p">)</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">start_coordinates</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span>

    <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ring</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">Length</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Dipole</span><span class="p">)</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">BendingAngle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">el</span><span class="o">.</span><span class="n">BendingAngle</span>
            <span class="n">ll</span> <span class="o">*=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span><span class="o">/</span><span class="n">ang</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">t</span> <span class="o">-=</span> <span class="n">ang</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">ll</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">ll</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">-=</span> <span class="n">ang</span>
        <span class="n">xx</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">yy</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">angle</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">dff</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">_GEOMETRY_EPSIL</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">_GEOMETRY_EPSIL</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_GEOMETRY_EPSIL</span><span class="p">:</span>
        <span class="n">xcenter</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
        <span class="n">ycenter</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dff</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_GEOMETRY_EPSIL</span><span class="p">:</span>
        <span class="n">xcenter</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">x</span>
        <span class="n">ycenter</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">y</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
        <span class="n">xcenter</span> <span class="o">=</span> <span class="o">-</span><span class="n">num</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
        <span class="n">ycenter</span> <span class="o">=</span> <span class="n">num</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="n">den</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xcenter</span><span class="o">*</span><span class="n">xcenter</span> <span class="o">+</span> <span class="n">ycenter</span><span class="o">*</span><span class="n">ycenter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">-=</span> <span class="n">xcenter</span>
        <span class="n">yy</span> <span class="o">-=</span> <span class="n">ycenter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xx</span> <span class="o">+=</span> <span class="n">x0</span>
        <span class="n">yy</span> <span class="o">+=</span> <span class="n">y0</span>
    <span class="n">geomdata</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">boolrefs</span><span class="p">]</span>
    <span class="n">geomdata</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">boolrefs</span><span class="p">]</span>
    <span class="n">geomdata</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span><span class="p">[</span><span class="n">boolrefs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">geomdata</span><span class="p">,</span> <span class="n">radius</span></div>
</pre></div>

            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1e1de1a1873e13ef5536"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022, ATCollab.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>